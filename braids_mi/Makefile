# Project Name
TARGET = braids_mi

# Library Locations
PROJECT_MAKEFILE := $(abspath $(lastword $(MAKEFILE_LIST)))
_P_DIR := $(patsubst %/,%,$(dir $(PROJECT_MAKEFILE)))
_P_UP1 := $(abspath $(_P_DIR)/..)
_P_UP2 := $(abspath $(_P_UP1)/..)
_P_UP3 := $(abspath $(_P_UP2)/..)
_P_UP4 := $(abspath $(_P_UP3)/..)
COMMON_MK := $(firstword \
	$(foreach d,$(_P_DIR) $(_P_UP1) $(_P_UP2) $(_P_UP3) $(_P_UP4),\
		$(if $(wildcard $(d)/make/common.mk),$(d)/make/common.mk,)))
ifeq ($(strip $(COMMON_MK)),)
$(error Could not find make/common.mk. Expected it in this repo; searched upwards from $(_P_DIR))
endif
include $(COMMON_MK)

LIBDAISY_DIR ?= $(DAISY_ROOT)/libDaisy

LIBDAISY_LIB ?= $(LIBDAISY_DIR)/build/libdaisy.a

# Shared Mutable Instruments (preferred)
# (MUTABLE_EURORACK default comes from make/common.mk)
BRAIDS_DIR ?= $(MUTABLE_EURORACK)/braids
STMLIB_DIR ?= $(MUTABLE_EURORACK)/stmlib

# Sources
CPP_SOURCES = \
	src/main.cpp \

# Build directory (used for generated config headers)
BUILD_DIR ?= build

# Braids build variant:
# - lite: trimmed analog-only subset (fits internal flash)
# - full: upstream Braids macro oscillator + digital oscillator (recommended for BOOT_QSPI)
BRAIDS_VARIANT ?= full

# V/Oct tuning defaults (can be overridden on the make command line).
# Note: we intentionally ignore any exported shell environment variables for
# these knobs; only explicit command-line overrides should win.
# Examples:
#  - 0V = C2: make ... VOCT_BASE_MIDI=36
#  - 0V = C3: make ... VOCT_BASE_MIDI=48
#  - Center trim: make ... VOCT_CENTER_NORM=0.497f
ifeq ($(origin VOCT_BASE_MIDI),command line)
else
VOCT_BASE_MIDI = 48
endif

ifeq ($(origin VOCT_CENTER_NORM),command line)
else
VOCT_CENTER_NORM = 0.5f
endif

# Auto-generate a config header so changes to VOCT_* force recompiles.
# Note: do not add this via C_INCLUDES, since that would also affect libDaisy's
# core sources (which compile before this file can generate the header).
VOCT_CONFIG_H := $(BUILD_DIR)/voct_config.h
VOCT_CONFIG_INCLUDE := -include $(VOCT_CONFIG_H)

# Allow sources to directly include "voct_config.h".
C_INCLUDES += -I$(BUILD_DIR)

# Braids DSP is .cc
ifeq ($(BRAIDS_VARIANT),full)
C_DEFS += -DBRAIDS_VARIANT_FULL
CC_SOURCES = \
	$(BRAIDS_DIR)/macro_oscillator.cc \
	$(BRAIDS_DIR)/digital_oscillator.cc \
	$(BRAIDS_DIR)/analog_oscillator.cc \
	$(BRAIDS_DIR)/resources.cc \
	$(STMLIB_DIR)/dsp/units.cc \
	$(STMLIB_DIR)/utils/random.cc

# Important: do not include local src/braids overrides (they limit models).
C_INCLUDES += \
	-I. \
	-I$(MUTABLE_EURORACK)
else
CC_SOURCES = \
	src/braids/macro_oscillator_mini.cc \
	$(BRAIDS_DIR)/analog_oscillator.cc \
	$(BRAIDS_DIR)/resources.cc \
	$(STMLIB_DIR)/dsp/units.cc \
	$(STMLIB_DIR)/utils/random.cc

C_INCLUDES += \
	-I. \
	-Isrc \
	-I$(MUTABLE_EURORACK)
endif

# Core location, and generic makefile.
SYSTEM_FILES_DIR = $(LIBDAISY_DIR)/core

# App type / linker selection
# - BOOT_NONE: normal app in internal flash (DFU-friendly)
# - BOOT_QSPI: Daisy bootloader app stored in external QSPI (SD card can flash it)
# - BOOT_SRAM: Daisy bootloader app running from SRAM
APP_TYPE ?= BOOT_QSPI

ifeq ($(APP_TYPE),BOOT_QSPI)
LDSCRIPT ?= $(SYSTEM_FILES_DIR)/STM32H750IB_qspi.lds
else ifeq ($(APP_TYPE),BOOT_SRAM)
LDSCRIPT ?= $(SYSTEM_FILES_DIR)/STM32H750IB_sram.lds
else
LDSCRIPT ?= $(SYSTEM_FILES_DIR)/STM32H750IB_flash.lds
endif
include $(SYSTEM_FILES_DIR)/Makefile

#######################################
# Extensions to libDaisy core Makefile
#######################################

# Generate the config header (and make sure it exists before any compilation
# that might include it).
all: $(VOCT_CONFIG_H)

$(VOCT_CONFIG_H): Makefile | $(BUILD_DIR)
	@printf '%s\n' \
		'#pragma once' \
		'#define VOCT_BASE_MIDI $(VOCT_BASE_MIDI)' \
		'#define VOCT_CENTER_NORM $(VOCT_CENTER_NORM)' \
		> $@

# Add Braids DSP (.cc) sources to the object list generated by libDaisy.
CC_OBJECTS := $(addprefix $(BUILD_DIR)/,$(notdir $(CC_SOURCES:.cc=.o)))
OBJECTS += $(CC_OBJECTS)
vpath %.cc $(sort $(dir $(CC_SOURCES)))

# Ensure the ELF target actually depends on the .cc objects.
# (The core Makefile expands $(OBJECTS) for prerequisites before our append.)
$(BUILD_DIR)/$(TARGET).elf: $(CC_OBJECTS)

# Avoid parallel-build races when sources include voct_config.h.
$(BUILD_DIR)/main.o $(CC_OBJECTS): $(VOCT_CONFIG_H)

$(BUILD_DIR)/%.o: %.cc Makefile $(VOCT_CONFIG_H) | $(BUILD_DIR)
	$(CXX) -c $(CPPFLAGS) $(VOCT_CONFIG_INCLUDE) $(CPP_STANDARD) -Wa,-a,-ad,-alms=$(BUILD_DIR)/$(notdir $(<:.cc=.lst)) $< -o $@
